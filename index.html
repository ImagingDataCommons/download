<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>IDC Download</h1>

  <script src="https://unpkg.com/dcmjs@0.41.0/build/dcmjs.js"></script>
  <script>
    let idc_data;
    let hyparquet;
    let asyncBufferFromUrl, parquetReadObjects, parquetMetadataAsync;

  </script>

  <script type="module">
      console.log("Starting IDC download example...")
      console.log("dcmjs version:", dcmjs.version)
      console.log("dcmjs is loaded:", dcmjs)

      hyparquet = await import('https://cdn.jsdelivr.net/npm/hyparquet@1.9.0/src/hyparquet.min.js')
      
      const idc_index_url = "https://storage.googleapis.com/idc-index-data-mirror/idc_index-v21.parquet"

      const idc_index_file = await hyparquet.asyncBufferFromUrl({ url: idc_index_url }) // wrap url for async fetching
      idc_data = await hyparquet.parquetReadObjects({
        file: idc_index_file,
        columns: ['collection_id', 'PatientID', 'series_aws_url'],
        rowStart: 10,
        rowEnd: 20,
      })

      console.log(idc_data)

      const x = new XMLHttpRequest()
      x.open("GET", "https://idc-open-data.s3.us-east-1.amazonaws.com/?list-type=2&prefix=a464")
      x.addEventListener("load", () => {
        console.log("Loaded IDC index data")
        const parser = new DOMParser()
        const xmls = x.response.toString()
        const doc = parser.parseFromString(xmls, "text/xml")
        console.log(doc)
        const items = doc.querySelectorAll("Contents")
        console.log("Items found:", items.length)
        items.forEach((item) => {
          const key = item.querySelector("Key").textContent
          const size = item.querySelector("Size").textContent
          console.log(`Key: ${key}, Size: ${size}`)
        })
      })
      x.send()


    </script>
  </body>
</html>